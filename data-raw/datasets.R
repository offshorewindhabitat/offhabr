# update db structure
#

librarian::shelf(
  devtools, dplyr, janitor, purrr, sf, tibble, tidyr)
load_all()
con <- oh_pg_con()

# restructure ----

# * spatial and general tables (2022-12-04) ----
# oh_cells      -> cells
# oh_cells_ply  -> cells_ds_ply
#   row_id -> mdl_id -> ply_id
# oh_cells_rast -> cells_ds_rast
#   value -> val
# oh_zones      -> zones
# boem_blocks   -> blocks

dbSendQuery(
  con,
  "ALTER TABLE cells_ds_ply ADD ds_key TEXT")
dbSendQuery(
  con,
  "ALTER TABLE cells_ds_ply DROP COLUMN id")

dbSendQuery(
  con,
  "ALTER TABLE cells_ds_rast ADD ds_key TEXT")
dbSendQuery(
  con,
  "ALTER TABLE cells_ds_rast DROP COLUMN id")

dbSendQuery(
  con,
  "ALTER TABLE taxa ADD ds_key TEXT")


# * datasets table ----

# dbSendQuery(con, "DROP TABLE ds")
dbSendQuery(
  con,
  "CREATE TABLE datasets (
  ds_key      TEXT,
  name_short  TEXT,
  name_long   TEXT,
  year        SMALLINT,
  description TEXT,
  source      TEXT,
  citation    TEXT)")

# * individual dataset tables (2022-12-04) ----
dbListTables(con)  %>% sort() %>% paste(collapse=" -> \n# ")%>% cat()
# am_cells        -> ds_am_cells
# am_meta         -> ds_am_meta
# am_spp          -> ds_am_spp
# am_spp_cells    -> ds_am_spp_cells
# am_spp_prefs    -> ds_am_spp_prefs
# du_density      -> ds_du
# gm_mdl_ply_vals -> ds_gm_ply_vals
# gm_mdls         -> ds_gm_mdls
# gm_plys         -> ds_gm_plys
# nc_density      -> ds_nc
# oa_models       -> ds_oa
# rl_range        -> ds_rl
# sm_model        -> ds_sm
# sw_density_ply  -> ds_sw_ply
# sw_models       -> ds_sw
# ve_model        -> ds_ve
# vg_model        -> ds_vg

# taxa ----

# * + taxa_rl.aphia_id ----
d_taxa_rl <- tbl(con, "taxa_rl") %>%
  rename(taxa = taxa_orig) %>%
  left_join(
    tbl(con, "taxa") %>%
      distinct(taxa, aphia_id),
    by = "taxa") %>%
  collect() %>%
  relocate(aphia_id)
dbWriteTable(con, "taxa_rl", d_taxa_rl, overwrite=T)
create_index(con, "taxa_rl", c("aphia_id","taxa"), unique=T)

# * create lookup table for RedList extinction category to rl_score ----

tbl(con, "taxa_rl") %>%
  group_by(category) %>%
  summarize(
    n = n(), .groups = "drop") %>%
  collect()
# A tibble: 7 × 2
#   category       n
#   <chr>    <int64>
# 1 CR            26
# 2 EN            39
# 3 LR/lc          1
# 4 VU            90
# 5 DD           163
# 6 NT            57
# 7 LC          2357

# https://marinebon.github.io/gmbi/articles/calc.html#calculate-extinction-risk
d_taxa_rl_catscores <- tribble(
  ~category, ~rl_score, ~description,
  "DD",             NA, "Data Deficient",
  "LC",              0, "Least Concern",
  "LR/lc",           0, "Lower Risk, least concern (1994 category)",
  "NT",              1, "Near Threatened",
  "LR/cd",           1, "Lower Risk, conservation dependent (1994 category)",
  "LR/nt",           1, "Lower Risk, near threatened (1994 category)",
  "VU",              2, "VUlnerable",
  "EN",              3, "ENdangered",
  "CR",              4, "CRitically endangered",
  "EW",             NA, "Extinct in the Wild",
  "EX",             NA, "EXtinct")
dbWriteTable(con, "taxa_rl_catscores", d_taxa_rl_catscores, overwrite=T)
create_index(con, "taxa_rl_catscores", "category", unique=T)

# * TODO: summarize taxa across datasets and ensure in taxa table ----
sql_ds_ply <- character(0)

# * TODO: try adding more to taxa_rl from RedList ----



# polygon datasets ----

tbl(con, "cells_ds_ply") %>%
  group_by(tbl) %>%
  summarize(
    n = n(), .groups = "drop") %>%
  collect()
# A tibble: 5 × 2
#   tbl                            n
#   <chr>                    <int64>
# 1 am_cells              14,910,891
# 2 gm_model_hexagons      3,535,323
# 3 rl_range           1,387,006,236
# 4 sw_density_ply         5,759,071

# am
# gm
# rl
# sw

tbl(con, "cells_ds_ply") %>%
  group_by(tbl, ds_key) %>%
  summarize(n = n()) %>%
  collect()
# A tibble: 4 × 3
# Groups:   tbl [4]
#   tbl               ds_key          n
#   <chr>             <chr>     <int64>
# 1 am_cells          NA       14910891
# 2 gm_model_hexagons gm        3535323
# 3 rl_range          NA     1387006236
# 4 sw_density_ply    NA        5759071

# * am ----
dbSendQuery(
  con,
  "ALTER TABLE ds_am_spp
  ADD COLUMN mdl_id INTEGER
  GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY;")

# ** 2. INSERT cells_ds
# *** TODO: rescale: 0.5 to 1? ----
tbl(con, "ds_am_spp_cells") %>%
  summarize(
    prob_min = min(probability, na.rm=T),
    prob_max = max(probability, na.rm=T)) %>%
  collect()
# 0.1 to 1 # originally only species having at least probability >= 0.5 included
ds_key      <- "am"
ds_tbl      <- "ds_am_spp_cells"
fld_ply_val <- "probability"
val_type    <- "probability"
# sql_ds_ply[ds_key] <- glue(
sql_ds_ply <- glue(
  "(
  SELECT
    ds.ds_key, ds.mdl_id, ds.aphia_id, ds.val_type,
    dv.ply_id, dc.cell_id,
    dv.val, dv.val_z
  FROM
    (SELECT
        'am' AS ds_key, mdl_id, species_id, aphia_id,
        '{val_type}' AS val_type
     FROM ds_am_spp) AS ds
  LEFT JOIN
    (SELECT species_id, hcaf_id AS ply_id,
     {fld_ply_val}::REAL AS val,
     CAST(
       {fld_ply_val} / MAX({fld_ply_val}) OVER (PARTITION BY species_id)
       AS REAL) AS val_z
     FROM ds_am_spp_cells) AS dv
    USING (species_id)
  LEFT JOIN
    (SELECT ply_id::INTEGER AS ply_id, cell_id
     FROM cells_ds_ply
     WHERE tbl = 'am_cells') AS dc
    USING (ply_id)
  ) AS ds_{ds_key}")
# dbGetQuery(con, sql_ds_ply)
cat(sql_ds_ply)
dbSendQuery(con, "DELETE FROM cells_ds WHERE ds_key = '{ds_key}'")
q <- glue(
  # "CREATE MATERIALIZED VIEW view_ds_cells AS
  "INSERT INTO cells_ds
    SELECT
      *,
      (val_z * rl_score)::REAL AS val_rl
    FROM
    -- datasets by polygon
    {paste(sql_ds_ply, collapse = '\nUNION\n')}
    -- cell attributes
    LEFT JOIN
      (SELECT
        cell_id, block_id, zone_id, elev
      FROM cells) AS c
      USING (cell_id)
    -- taxa attributes
    LEFT JOIN
      (SELECT
         aphia_id, scientificname, taxon_rank_id, rank,
         kingdom, phylum, class, \"order\", family, genus
       FROM taxa_wm
       GROUP BY
        aphia_id, scientificname, taxon_rank_id, rank,
         kingdom, phylum, class, \"order\", family, genus) AS tw
      USING (aphia_id)
    LEFT JOIN
      (SELECT
         aphia_id, category AS rl_category, population_trend AS rl_trend
       FROM taxa_rl
       GROUP BY
        aphia_id, category, population_trend) AS tr
      USING (aphia_id)
    LEFT JOIN
      (SELECT category AS rl_category, rl_score
      FROM taxa_rl_catscores) trc
      USING (rl_category)
    -- filters
    WHERE
      zone_id IS NOT NULL
    ")
cat(q)
# writeLines(q, "_tmp_view_ds_cells.sql")
system.time({
dbSendQuery(con, q)
# 8.1 hrs
  # Error: Failed to fetch row: ERROR: could not extend file "base/16449/133122.919": No space left on device
  #   HINT: Check free disk space.
})

# *** test ----
con <- oh_pg_con()
x_sp <- tbl(con, "cells_ds") %>%
  filter(
    ds_key == "am",
    mdl_id == 1) %>%
  group_by(aphia_id, scientificname) %>%
  summarize() %>%
  collect()
x_sp
#   aphia_id scientificname
#      <int> <chr>
# 1   392274 Leiogalathea laevirostris
x <- tbl(con, "cells_ds") %>%
  filter(
    ds_key == "am",
    mdl_id == 1) %>%
  select(
    cell_id, val) %>%
  collect()

library(terra)
r <- oh_rast()
r[x$cell_id] <- x$val
r <- trim(r)
plot(r)
mapView(r, maxpixels=ncell(r))

a <- tbl(con, "ds_am_spp") %>%
  filter(aphia_id == 392274) %>%
  select(species_id) %>%
  left_join(
    tbl(con, "ds_am_spp_cells"),
    by = "species_id") %>%
  select(hcaf_id, probability) %>%
  collect()
b <- st_read(
  con,
  query =
    glue(
      "SELECT hcaf_id, geom FROM ds_am_cells
    WHERE hcaf_id IN ({paste(a$hcaf_id, collapse=',')})")) %>%
  left_join(
    a, by = "hcaf_id")
mapView(r, maxpixels=ncell(r)) +
  mapview(b, zcol="probability")

# * gm ----

# 2022-12-03: manually in DBeaver
# gm_models                  -> ds_gm
#   row_id  -> mdl_id
#   + ply_fld_val
# gm_mdl_ply_vals
#   hex_id  -> ply_id
#   density -> val
# gm_model_hexagons          -> ds_gm_plys
#   hexid   -> ply_id
#   val     -> density
# gm_model_hexagon_densities -> ds_gm_ply_vals

ds_key      <- "gm"
ds_tbl      <- "gm_model_hexagons"
fld_ply_val <- "density"
val_type    <- "density"
# cells_ds_ply.ds_key (old: .tbl)
dbSendQuery(
  con, glue(
    "UPDATE cells_ds_ply SET
      ds_key = '{ds_key}'
    WHERE tbl = '{ds_tbl}'"))
# taxa.ds_key  (old: .tbl)
dbSendQuery(
  con, glue(
    "UPDATE taxa SET
      ds_key = '{ds_key}'
    WHERE tbl = '{ds_tbl}'"))
# + ds_{ds_key}.ds_key
dbSendQuery(
  con, glue(
    "ALTER TABLE ds_{ds_key} ADD ds_key TEXT"))
dbSendQuery(
  con, glue(
    "UPDATE ds_{ds_key} SET ds_key = '{ds_key}'"))
# + ds_{ds_key}.fld_ply_val
dbSendQuery(
  con, glue(
    "ALTER TABLE ds_gm ADD fld_ply_val TEXT"))
dbSendQuery(
  con, glue(
    "UPDATE ds_{ds_key} SET fld_ply_val = '{fld_ply_val}'"))
# + ds_{ds_key}.val_type
dbSendQuery(
  con, glue(
    "ALTER TABLE ds_{ds_key} ADD val_type TEXT"))
dbSendQuery(
  con, glue(
    "UPDATE ds_{ds_key} SET val_type = '{val_type}'"))

# ** test model output ----

# sql_ds_ply <- character(0)
# ds_key <- "gm"
# fld_ply_val <- tbl(con, tbl_ds) %>%
#   distinct(fld_ply_val) %>%
#   pull(fld_ply_val)
# if (length(fld_ply_val) > 1)
#   stop("Hmm... haven't yet sorted more than one unique value for fld_ply_val per dataset")
#
# d_z <- tbl(con, "ds_gm_ply_vals") %>%
#   filter(
#     mdl_id == 1) %>%
#   mutate(
#     val_z = density / max(density, na.rm=T)) %>%
#   collect()
# d_z <- tbl(con, "ds_gm_ply_vals") %>%
#   group_by(mdl_id) %>%
#   mutate(
#     val_z = density / max(density, na.rm=T)) %>%
#   show_query()
# SELECT *, "density" / MAX("density") OVER (PARTITION BY "mdl_id") AS "val_z"
# FROM "ds_gm_ply_vals"
  # collect()
# range(d_z$val_z)
# d_z %>% filter(mdl_id==3) %>% pull(val_z) %>% range()

# get single model of polygons
# plys <- st_read(
#   con, query =
#   "SELECT *
#   FROM ds_gm_plys
#   LEFT JOIN
#     ds_gm_ply_vals USING (ply_id)
#   WHERE
#     mdl_id = 1 AND
#     density IS NOT NULL")

# ** 1. CREATE cells_ds ----
ds_key      <- "gm"
ds_tbl      <- "ds_gm_ply_vals"
fld_ply_val <- "density"
val_type    <- "density"
# sql_ds_ply[ds_key] <- glue(
sql_ds_ply <- glue(
  "(
  SELECT
    ds.ds_key, ds.mdl_id, ds.aphia_id, ds.val_type,
    dv.ply_id, dc.cell_id,
    dv.val, dv.val_z
  FROM
    (SELECT ds_key, mdl_id, aphia_id, val_type
     FROM ds_{ds_key}) AS ds
  LEFT JOIN
    (SELECT mdl_id, ply_id,
     {fld_ply_val}::REAL AS val,
     ({fld_ply_val} / MAX({fld_ply_val}))::REAL OVER (PARTITION BY mdl_id) AS val_z
     FROM ds_{ds_key}_ply_vals) AS dv
    USING (mdl_id)
  LEFT JOIN
    (SELECT ply_id::INTEGER AS ply_id, cell_id
     FROM cells_ds_ply
     WHERE ds_key = '{ds_key}') AS dc
    USING (ply_id)
  ) AS ds_{ds_key}")
# cat(sql_ds_ply[ds_key])
cat(sql_ds_ply)
# dbSendQuery(con, "DROP MATERIALIZED VIEW IF EXISTS view_ds_cells CASCADE")
dbSendQuery(con, "DROP TABLE IF EXISTS cells_ds CASCADE")
q <- glue(
  # "CREATE MATERIALIZED VIEW view_ds_cells AS
  "CREATE TABLE cells_ds AS
    SELECT
      *,
      (val_z * rl_score)::REAL AS val_rl
    FROM
    -- datasets by polygon
    {paste(sql_ds_ply, collapse = '\nUNION\n')}
    -- cell attributes
    LEFT JOIN
      (SELECT
        cell_id, block_id, zone_id, elev
      FROM cells) AS c
      USING (cell_id)
    -- taxa attributes
    LEFT JOIN
      (SELECT
         aphia_id, scientificname, taxon_rank_id, rank,
         kingdom, phylum, class, \"order\", family, genus
       FROM taxa_wm
       GROUP BY
        aphia_id, scientificname, taxon_rank_id, rank,
         kingdom, phylum, class, \"order\", family, genus) AS tw
      USING (aphia_id)
    LEFT JOIN
      (SELECT
         aphia_id, category AS rl_category, population_trend AS rl_trend
       FROM taxa_rl
       GROUP BY
        aphia_id, category, population_trend) AS tr
      USING (aphia_id)
    LEFT JOIN
      (SELECT category, rl_score
      FROM taxa_rl_catscores) trc
      USING (category)
    -- filters
    WHERE
      zone_id IS NOT NULL
    ")
cat(q)
writeLines(q, "_tmp_view_ds_cells.sql")
dbSendQuery(con, q) # 35,633,972 rows; 6.1 G
# these TYPE changes should now be handled above by casts (*::INTEGER) or
# changing origin column TYPE:
  # dbSendQuery(con, "ALTER TABLE cells_ds ALTER COLUMN ply_id   TYPE INTEGER")
  # dbSendQuery(con, "ALTER TABLE cells_ds ALTER COLUMN val      TYPE REAL")
  # dbSendQuery(con, "ALTER TABLE cells_ds ALTER COLUMN val_z    TYPE REAL")
  # dbSendQuery(con, "ALTER TABLE cells_ds ALTER COLUMN rl_score TYPE SMALLINT")
  # dbSendQuery(con, "ALTER TABLE cells_ds ALTER COLUMN val_rl   TYPE REAL")

# TODO: create indexes
create_index(con, "view_ds_cells", c("ds_key", "mdl_id", "cell_id"), unique=T)
create_index(con, "view_ds_cells", "zone_id")
create_index(con, "view_ds_cells", "block_id")
create_index(con, "view_ds_cells", "aphia_id")

x <- tbl(con, "view_ds_cells") %>%
  filter(cell_id == 81296505) %>%
  collect()
x
x_sum <- x %>%
  # select(aphia_id, scientificname, val, val_z, category, rl_score, score) %>%
  group_by(cell_id) %>%
  summarize(
    n_taxa = n(),
    avg_z  = mean(val_z, na.rm=T),
    avg_rl = mean(val_rl, na.rm=T))

# TODO:
# - normalize for whole region X in/out OA regions (so add oa_rgn to cell_id)
#   - intersect oh_regions with oa_regions
#   - add Region (ATL, PAC, GOM)
#   - update cells with new zone_id as INT4
# - append to tbl per ds-mdl with multidplyr, vs materialized view
# - score = richness X abundance X extinction
#   * again rescaled per zone 0 to 1
#   * and rescaled across all Regions for biggest picture, so reference depends on scale of interest
# - plot sunburst:
#   * taxonomy (kingdom -> genus -> sp)
#   * extinction category, taxonomy
#   * color by richness or abundance?

# summarize taxa score by pixel
tbl(con, "taxa") %>%
  group_by(tbl) %>%
  summarize(n = n()) %>%
  collect()
# A tibble: 7 × 2
# tbl              n
# <chr>      <int64>
# 1 am_spp        9,766
# 2 gm_models        17
# 3 du_density       68
# 4 rl_range      1,388
# 5 x                24
# 6 sw_density       13
# 7 nc_density       80

# check per ds: nrow(view_ds_cells) vs nrow(cells_ds_ply)
dz_smry <- tbl(con, "view_ds_cells") %>%
  group_by(ds_key, zone_id) %>%
  summarize(
    n = n(), .groups="drop") %>%
  collect()
dz_smry
# A tibble: 5 × 3
#   ds_key zone_id          n
#   <chr>    <dbl>    <int64>
# 1 gm           2 15,748,882
# 2 gm           3 12,715,078
# 3 gm           4    943,526
# 4 gm          11  6,226,486
sum(dz_smry$n)   # 35,633,972



# TODO: add taxa attributes to view_ds_cells

# calculate values by zone



d <- tbl(con, "ds_gm") %>%
  filter(taxa_sci == "Ziphius") %>%
  left_join(
    tbl(con, "ds_gm_ply_vals"),
    by = "mdl_id") %>%
  left_join(
    tbl(con, "cells_ds_ply") %>%
      filter(ds_key == "gm"),
    by = "ply_id") %>%
  select(cell_id, density) %>%
  filter(            # 1,977,010 -> 1,959,979
    !is.na(cell_id),
    !is.na(density)) %>%
  show_query()
  collect()


library(terra)
r <- oh_rast()
r[d$cell_id] <- d$density
r <- trim(r)
plot(r)
mapView(r, maxpixels=ncell(r))

# * rl ----

# * sw ----

# sw_density -> sw_models
# sw_models.row_id -> mdl_id

# * cleanup ----

# check all ds_key values set before dropping tbl
tbl(con, "cells_ds_ply") %>%
  group_by(tbl, ds_key) %>%
  summarize(
    n = n(), .groups = "drop") %>%
  collect()
dbSendQuery(
  con,
  "ALTER TABLE cells_ds_ply DROP COLUMN tbl")

# raster datasets ----

# TODO: add ds_key, drop tbl, udpate index

tbl(con, "oh_cells_rast") %>%
  group_by(tbl) %>%
  summarize(
    n = n(), .groups = "drop") %>%
  collect()
# A tibble: 6 × 1
#   tbl
#   <chr>
# 1 du_density
# 2 nc_density
# 3 oa_models
# 4 sm_model
# 5 ve_model
# 6 vg_model

# * du ----

# * nc ----

# * oa ----

# * sm ----

# * ve ----

# * vg ----

# * cleanup ----
dbSendQuery(con, "ALTER TABLE cells_ds_rast DROP COLUMN id")

# check all ds_key values set before dropping cells_ds_rast.tbl
tbl(con, "cells_ds_rast") %>%
  group_by(tbl, ds_key) %>%
  summarize(
    n = n(), .groups = "drop") %>%
  collect()
dbSendQuery(
  con,
  "ALTER TABLE cells_ds_rast DROP COLUMN tbl")

# check all ds_key values set before dropping taxa.tbl
tbl(con, "taxa") %>%
  group_by(tbl, ds_key) %>%
  summarize(
    n = n(), .groups = "drop") %>%
  collect()
dbSendQuery(
  con,
  "ALTER TABLE taxa DROP COLUMN tbl")
